{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="min-h-screen bg-gray-50 px-4 py-8">
  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-8">

    <!-- Title -->
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Tracking Parameters</h2>

    <!-- Picker -->
    <div class="mb-6">
      <label class="block text-gray-700 font-semibold mb-2">Existing parameters</label>
      <div class="flex flex-wrap gap-3 items-center">
        <select id="paramPicker" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="">-- Select param to edit --</option>
          {% for p in params %}
            <option value="{{ p.pk }}">
              {% if p.platform %}{{ p.platform.name }}{% else %}Param #{{ p.pk }}{% endif %}
            </option>
          {% endfor %}
        </select>
        <button type="button" id="loadBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition">Load</button>
        <form id="deleteForm" method="post" class="inline">
          {% csrf_token %}
          <input type="hidden" name="dummy" />
        </form>
        <button id="clearBtn" type="button" class="px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-100 transition">Clear</button>
      </div>
      <p class="text-gray-500 mt-2 text-sm">Pick an existing parameter and click <strong>Load</strong> to edit it.</p>
    </div>

    <!-- Form -->
    <form method="post" id="paramForm" class="space-y-6">
      {% csrf_token %}
      <input type="hidden" name="param_id" id="param_id" value="">

      <!-- Platform -->
      <div>
        <label class="block text-gray-700 font-semibold mb-2">Platform</label>
        {{ form.platform }}
        {% for e in form.platform.errors %}<div class="text-red-600 text-sm mt-1">{{ e }}</div>{% endfor %}
      </div>

      <!-- Active Checkbox -->
      <div class="flex items-center space-x-2">
        {{ form.is_active }}
        <label class="text-gray-700 font-semibold">Active</label>
      </div>

      <!-- JSON Params -->
      <div>
        <label class="block text-gray-700 font-semibold mb-2">Params (JSON)</label>
        {{ form.params }}
        {% if form.params.help_text %}<p class="text-gray-500 text-sm mt-1">{{ form.params.help_text }}</p>{% endif %}
        {% for e in form.params.errors %}<div class="text-red-600 text-sm mt-1">{{ e }}</div>{% endfor %}
      </div>

     <!-- Example JSON -->
<div class="bg-gray-100 border border-dashed border-gray-300 rounded-xl p-4 text-sm text-gray-700 break-words">
  <strong>Example JSON:</strong> 
  <code class="break-words">{"utm_source":"newsletter","utm_medium":"email","utm_campaign":"fall"}</code>
</div>
      <!-- Form Actions -->
      <div class="flex flex-wrap gap-3 justify-end mt-4">
        <button class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition" type="submit">Save</button>
        <button class="px-6 py-3 border border-gray-300 rounded-xl hover:bg-gray-100 transition" type="button" id="cancelEdit">Cancel Edit</button>
        <button class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition" type="button" id="deleteBtn" style="display:none">Delete</button>
      </div>
    </form>
  </div>
</div>

<script>
const picker = document.getElementById('paramPicker');
const loadBtn = document.getElementById('loadBtn');
const paramIdField = document.getElementById('param_id');
const deleteBtn = document.getElementById('deleteBtn');
const cancelEdit = document.getElementById('cancelEdit');
const clearBtn = document.getElementById('clearBtn');

clearBtn.addEventListener('click', function() {
    clearForm();
});

function setFormData(data) {
  paramIdField.value = data.id || '';
  const platformSelect = document.querySelector('#paramForm [name="platform"]');
  if(platformSelect) platformSelect.value = data.platform || '';
  
  const paramsField = document.querySelector('#paramForm [name="params"]');
  if(paramsField) {
    try { paramsField.value = JSON.stringify(data.params || {}, null, 2); }
    catch(e){ paramsField.value = ''; }
  }

  const activeField = document.querySelector('#paramForm [name="is_active"]');
  if(activeField) activeField.checked = !!data.is_active;

  if(data.id){
    deleteBtn.style.display = '';
    document.getElementById('deleteForm').action = "{% url 'catalog:param_delete' 0 %}".replace('/0/', '/' + data.id + '/');
  } else {
    deleteBtn.style.display = 'none';
    document.getElementById('deleteForm').action = "";
  }
}

function clearForm(){
  paramIdField.value = '';
  const platformSelect = document.querySelector('#paramForm [name="platform"]');
  if(platformSelect) platformSelect.value = '';
  const paramsField = document.querySelector('#paramForm [name="params"]');
  if(paramsField) paramsField.value = '';
  const activeField = document.querySelector('#paramForm [name="is_active"]');
  if(activeField) activeField.checked = true;
  deleteBtn.style.display = 'none';
  picker.value = '';
}

loadBtn.addEventListener('click', function(){
  const id = picker.value;
  if(!id){ alert('Please select a parameter to load.'); return; }
  const url = "{% url 'catalog:param_detail_json' 999999 %}".replace('999999', id);
  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => { if(!r.ok) throw new Error('Failed to fetch'); return r.json(); })
    .then(data => { setFormData(data); })
    .catch(err => { console.error(err); alert('Failed to load parameter.'); });
});

cancelEdit.addEventListener('click', clearForm);

deleteBtn.addEventListener('click', function(){
  if(!confirm('Delete this parameter?')) return;
  document.getElementById('deleteForm').submit();
});

// Apply Tailwind styling dynamically to Django form fields
document.addEventListener('DOMContentLoaded', () => {
  const inputs = document.querySelectorAll('#paramForm input, #paramForm select, #paramForm textarea');
  inputs.forEach(el => {
    el.classList.add(
      'w-full', 'px-4', 'py-3', 'border', 'border-gray-300', 'rounded-xl',
      'focus:ring-2', 'focus:ring-blue-400', 'focus:outline-none', 'text-gray-700'
    );
  });

  const checkboxes = document.querySelectorAll('#paramForm input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.classList.add('mr-2', 'w-5', 'h-5', 'text-blue-600', 'border-gray-300', 'rounded');
  });
});
</script>

{% endblock %}
