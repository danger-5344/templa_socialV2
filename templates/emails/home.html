{% extends 'base.html' %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 font-inter rounded-2xl overflow-hidden"
     style="--bg:#ffffff; --ink:#111827; --muted:#6b7280; --bd:#e5e7eb; --brand:#111827; --btn:#111827; --btn-ink:#fff; --btn-danger:#e74c3c; --btn-danger-hover:#c0392b; background-color: var(--bg); color: var(--ink);">

  <!-- Search Card -->
  <div class="flex justify-center mb-10">
    <form method="get" class="flex flex-col sm:flex-row gap-3 w-full max-w-3xl">
      <input type="text" name="q" value="{{q}}" placeholder="Search public templates"
             class="flex-1 px-4 py-3 rounded-xl border border-[var(--bd)] bg-white/80 backdrop-blur-sm text-[var(--ink)] placeholder-[var(--muted)] focus:outline-none focus:ring-2 focus:ring-[var(--brand)] focus:border-[var(--brand)] transition" />
      <button class="px-5 py-3 rounded-xl font-semibold text-[var(--btn-ink)] bg-[var(--btn)] shadow hover:bg-opacity-90 transform hover:-translate-y-1 transition">
        Search
      </button>
    </form>
  </div>

  <!-- Templates Grid -->
  <div class="grid gap-7 sm:grid-cols-2 lg:grid-cols-3">
    {% for t in templates %}
    <div class="relative bg-white/90 backdrop-blur-sm border border-[var(--bd)] rounded-2xl overflow-hidden flex flex-col transition-transform transform hover:scale-80 hover:-translate-y-1 hover:shadow-2xl">
      
      <!-- Ribbon -->
      {% if t.id in used_template_ids %}
      <div class="absolute top-4 -right-6 rotate-45 bg-green-600 text-white font-semibold text-xs py-1 px-9 shadow-lg">Used</div>
      {% endif %}

      <!-- Snapshot -->
      {% if t.snapshot %}
      <img src="{{ t.snapshot.url }}" alt="{{ t.title }}" class="w-full h-44 object-cover">
      {% else %}
      <div class="h-44 flex items-center justify-center text-[var(--muted)] text-sm border-b border-dashed border-[var(--bd)]">
        No snapshot
      </div>
      {% endif %}

      <!-- Info -->
      <div class="p-5 flex flex-col gap-2">
        <h3 class="text-lg font-semibold text-[var(--ink)]">{{ t.title }}</h3>
        <p class="text-sm text-[var(--muted)]">
          by {{ t.owner.username }}{% if t.platform %} · Platform: {{ t.platform.name }}{% endif %}
        </p>
        <p class="text-sm text-[var(--muted)]">Updated at: {{ t.updated_at|date:"M d, Y H:i" }}</p>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3 mt-3">
          <a href="{% url 'emails:template_use' t.pk %}"
             class="flex-1 text-center px-4 py-2 rounded-lg bg-[var(--btn)] text-[var(--btn-ink)] font-semibold shadow hover:bg-opacity-90 transition">
            Use Template
          </a>
          <button type="button" 
                  class="flex-1 px-4 py-2 rounded-lg border border-[var(--btn)] text-[var(--btn)] font-semibold hover:bg-[var(--btn)] hover:text-[var(--btn-ink)] shadow transition"
                  data-preview-url="{% url 'emails:template_preview' t.pk %}" onclick="openPreview(event, this)">
            Preview
          </button>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center text-[var(--muted)] py-20 bg-white rounded-2xl shadow">
      No public templates yet.
    </div>
    {% endfor %}
  </div>

  <!-- ✅ Pagination Section -->
  {% if templates.has_other_pages %}
  <div class="flex justify-center mt-10">
    <nav class="inline-flex items-center space-x-2 bg-white/90 backdrop-blur-sm px-5 py-3 rounded-xl border border-[var(--bd)] shadow-md text-sm font-medium">
      {% if templates.has_previous %}
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ templates.previous_page_number }}" 
           class="px-3 py-1 rounded-lg border border-[var(--bd)] hover:bg-[var(--brand)] hover:text-white transition">« Prev</a>
      {% else %}
        <span class="px-3 py-1 rounded-lg border border-[var(--bd)] text-gray-400 opacity-60">« Prev</span>
      {% endif %}

      {% for i in templates.paginator.page_range %}
        {% if i == templates.number %}
          <span class="px-3 py-1 rounded-lg bg-[var(--brand)] text-white shadow">{{ i }}</span>
        {% elif i > templates.number|add:'-3' and i < templates.number|add:'3' %}
          <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ i }}" 
             class="px-3 py-1 rounded-lg border border-[var(--bd)] hover:bg-[var(--brand)] hover:text-white transition">{{ i }}</a>
        {% endif %}
      {% endfor %}

      {% if templates.has_next %}
        <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}page={{ templates.next_page_number }}" 
           class="px-3 py-1 rounded-lg border border-[var(--bd)] hover:bg-[var(--brand)] hover:text-white transition">Next »</a>
      {% else %}
        <span class="px-3 py-1 rounded-lg border border-[var(--bd)] text-gray-400 opacity-60">Next »</span>
      {% endif %}
    </nav>
  </div>
  {% endif %}

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity z-50">
    <div role="dialog" aria-modal="true" class="bg-white rounded-2xl w-full max-w-4xl max-h-[85vh] overflow-y-auto relative p-6 shadow-2xl">
      <button onclick="closePreview()" aria-label="Close"
              class="absolute top-4 right-4 bg-[var(--bd)] rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-300 transition">
        ✕
      </button>
      <div id="previewContent" class="text-[var(--ink)]">Loading…</div>
    </div>
  </div>

</div>

<script>
function openPreview(e, btn) {
  if (e) e.preventDefault();
  const url = btn.getAttribute('data-preview-url');
  const modal = document.getElementById('previewModal');
  const content = document.getElementById('previewContent');
  modal.classList.add('opacity-100', 'pointer-events-auto');
  content.innerHTML = 'Loading…';
  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(html => { content.innerHTML = html; })
    .catch(() => { content.innerHTML = '<div class="text-center text-[var(--btn-danger)]">Failed to load preview.</div>'; });
}

function closePreview() {
  const modal = document.getElementById('previewModal');
  modal.classList.remove('opacity-100', 'pointer-events-auto');
}

document.addEventListener('keydown', (e) => { if(e.key==='Escape') closePreview(); });
document.getElementById('previewModal')?.addEventListener('click', (e)=>{ if(e.target.id==='previewModal') closePreview(); });
</script>

{% endblock %}
