{% extends 'base.html' %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-6  rounded-2xl overflow-hidden" style="--bg:#f6f7f9; --ink:#111827; --muted:#6b7280; --bd:#e5e7eb; --brand:#111827; --btn:#111827; --btn-ink:#fff; --btn-danger:#e74c3c; --btn-danger-hover:#c0392b; background-color: var(--bg); color: var(--ink);">

  <!-- Header Card -->
  <div class="bg-white rounded-xl shadow p-6 space-y-3">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
      <h2 class="text-lg font-semibold text-[var(--ink)] flex-1">📩 Preview: <span class="text-blue-600">{{ template.title }}</span></h2>
      <div class="flex items-center gap-2">
        🆔 Template ID: <span id="template-id" class="font-mono text-[var(--muted)]">{{ template.template_id }}</span>
        <button class="bg-[var(--btn)] text-[var(--btn-ink)] px-3 py-1 rounded hover:bg-red-700 active:scale-95 transition" onclick="copyPlainText('template-id')">Copy</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-4 text-[var(--muted)] mt-2">
      {% if platform %}<p><strong>Platform:</strong> {{ platform.name }}</p>{% endif %}
      {% if offer_link %}<p><strong>Offer Link:</strong> <a href="{{ offer_link.url }}" target="_blank" class="text-blue-600 underline break-all">{{ offer_link.url }}</a></p>{% endif %}
      {% if cta_url %}<p><strong>CTA URL:</strong> <a href="{{ cta_url }}" target="_blank" class="text-blue-600 underline break-all">{{ cta_url }}</a></p>{% endif %}
    </div>
  </div>

  <!-- Subject & From Name Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    <!-- Subject Line -->
    <div class="bg-white rounded-xl shadow p-4 flex flex-col">
      <div class="flex justify-between items-start mb-2">
        <h3 class="text-[var(--ink)] font-semibold text-md">📌 Subject Line</h3>
        <button class="bg-[var(--btn)] text-[var(--btn-ink)] px-2 py-1 rounded hover:bg-blue-700 active:scale-95 transition text-sm" onclick="copyPlainText('subject-line')">Copy</button>
      </div>
      <div id="subject-line" class="bg-[var(--bd)] p-3 rounded-md font-mono text-sm break-words">{{ template.subject }}</div>
    </div>

    <!-- From Name -->
    <div class="bg-white rounded-xl shadow p-4 flex flex-col">
      <div class="flex justify-between items-start mb-2">
        <h3 class="text-[var(--ink)] font-semibold text-md">📌 From Name</h3>
        <button class="bg-[var(--btn)] text-[var(--btn-ink)] px-2 py-1 rounded hover:bg-blue-700 active:scale-95 transition text-sm" onclick="copyPlainText('from-line')">Copy</button>
      </div>
      <div id="from-line" class="bg-[var(--bd)] p-3 rounded-md font-mono text-sm break-words">{{ template.from_name }}</div>
    </div>
  </div>

  <!-- HTML Body -->
  <div class="bg-white rounded-xl shadow p-4 flex flex-col space-y-2">
    <div class="flex justify-between items-start mb-2">
      <h3 class="text-[var(--ink)] font-semibold text-md">💻 HTML Body</h3>
      <button class="bg-[var(--btn)] text-[var(--btn-ink)] px-2 py-1 rounded hover:bg-blue-700 active:scale-95 transition text-sm" onclick="copyToClipboard('html-code')">Copy HTML</button>
    </div>
    <iframe
      id="html-code"
      class="w-full min-h-[500px] border border-[var(--bd)] rounded-md bg-white"
      sandbox="allow-same-origin"
    ></iframe>
    <details class="mt-2">
      <summary class="cursor-pointer font-medium text-blue-600">Show HTML Source</summary>
      <pre class="bg-[var(--brand)] text-[var(--btn-ink)] rounded-md p-3 mt-2 text-xs overflow-x-auto">{{ filled_html|escape }}</pre>
    </details>
  </div>

  <!-- Text Body -->
  {% if filled_text %}
  <div class="bg-white rounded-xl shadow p-4 flex flex-col space-y-2">
    <div class="flex justify-between items-start mb-2">
      <h3 class="text-[var(--ink)] font-semibold text-md">📝 Text Body</h3>
      <button class="bg-[var(--btn)] text-[var(--btn-ink)] px-2 py-1 rounded hover:bg-blue-700 active:scale-95 transition text-sm" onclick="copyToClipboard('text-code')">Copy Text</button>
    </div>
    <pre id="text-code" class="bg-[var(--bd)] rounded-md p-3 font-mono text-sm break-words">{{ filled_text }}</pre>
  </div>
  {% endif %}

</div>

<script>
function copyPlainText(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(() => alert('Copied: ' + text))
    .catch(err => alert('Failed to copy: ' + err));
}

function copyToClipboard(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (id === 'html-code') {
    const pre = el.parentElement.querySelector('pre');
    if (pre) {
      navigator.clipboard.writeText(pre.textContent).then(() => alert('Copied template HTML!'))
        .catch(err => alert('Failed to copy: ' + err));
      return;
    }
  }
  const text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'))
    .catch(err => alert('Failed to copy: ' + err));
}

(function() {
  const html = `{{ filled_html|escapejs }}`;
  const iframe = document.getElementById('html-code');
  if (!iframe) return;
  iframe.onload = function() {
    iframe.contentDocument.open();
    iframe.contentDocument.write(html);
    iframe.contentDocument.close();
  };
  if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
    iframe.contentDocument.open();
    iframe.contentDocument.write(html);
    iframe.contentDocument.close();
  }
})();
</script>

{% endblock %}
